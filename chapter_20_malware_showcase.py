#!/usr/bin/env python3
"""
Chapter 20: Malware Showcase
This script demonstrates cloning and testing malware samples for educational purposes.
WARNING: Only use in isolated environments! For learning purposes only!
"""

import subprocess
import os

def clone_repository():
    """
    Clones the malware showcase repository.
    
    This repository contains educational malware samples written in Python.
    These are for learning about malware techniques, not for malicious use.
    """
    
    print("="*60)
    print("Cloning Malware Repository")
    print("="*60)
    
    repo_url = "https://github.com/JunHao95/malware_python.git"
    repo_dir = "malware_python"
    
    print(f"[*] Repository: {repo_url}")
    
    # Check if already cloned
    if os.path.exists(repo_dir):
        print(f"[!] Directory {repo_dir} already exists")
        response = input("[?] Delete and re-clone? (yes/no): ").strip().lower()
        
        if response in ['yes', 'y']:
            print("[*] Removing existing directory...")
            subprocess.run(['rm', '-rf', repo_dir])
        else:
            print("[*] Using existing repository")
            return True
    
    # Clone the repository
    print("[*] Cloning repository...")
    
    try:
        result = subprocess.run(
            ['git', 'clone', repo_url],
            capture_output=True,
            text=True,
            timeout=60
        )
        
        if result.returncode == 0:
            print("[+] Repository cloned successfully!")
            return True
        else:
            print(f"[-] Clone failed: {result.stderr}")
            return False
            
    except FileNotFoundError:
        print("[-] Git not found. Install with: sudo apt install git")
        return False
    except Exception as e:
        print(f"[-] Error: {e}")
        return False


def list_malware_samples():
    """
    Lists available malware samples in the repository.
    """
    
    print("\n" + "="*60)
    print("Available Malware Samples")
    print("="*60)
    
    repo_dir = "malware_python"
    
    if not os.path.exists(repo_dir):
        print("[-] Repository not found")
        return []
    
    # List Python files
    samples = []
    
    for root, dirs, files in os.walk(repo_dir):
        for file in files:
            if file.endswith('.py') and not file.startswith('__'):
                filepath = os.path.join(root, file)
                samples.append(filepath)
    
    print(f"\n[+] Found {len(samples)} Python samples:\n")
    
    for i, sample in enumerate(samples, 1):
        print(f"  [{i}] {sample}")
    
    return samples


def analyze_malware_sample(filepath):
    """
    Analyzes a malware sample (reads and displays code).
    
    Args:
        filepath (str): Path to the malware sample
    
    This shows what the malware does without executing it.
    """
    
    print("\n" + "="*60)
    print(f"Analyzing: {filepath}")
    print("="*60)
    
    if not os.path.exists(filepath):
        print("[-] File not found")
        return
    
    print("\n[Code Analysis]")
    print("-"*60)
    
    try:
        with open(filepath, 'r') as f:
            code = f.read()
            print(code)
        print("-"*60)
        
    except Exception as e:
        print(f"[-] Error reading file: {e}")


def main():
    """
    Main function for malware showcase.
    """
    
    print("\n" + "ðŸ”¥"*30)
    print("Chapter 20: Village in Ruins - Malware Showcase Quest")
    print("ðŸ”¥"*30 + "\n")
    
    print("[!] CRITICAL WARNING!")
    print("[!] This chapter deals with malware samples")
    print("[!] ONLY run in isolated VMs with no network access")
    print("[!] NEVER run on production systems")
    print("[!] For educational purposes ONLY\n")
    
    response = input("[?] Do you understand the risks? (yes/no): ").strip().lower()
    
    if response not in ['yes', 'y']:
        print("[*] Quest cancelled for safety")
        return
    
    # Clone repository
    if not clone_repository():
        print("[-] Failed to clone repository")
        return
    
    # List samples
    samples = list_malware_samples()
    
    if not samples:
        print("[-] No samples found")
        return
    
    # Select samples to analyze
    print("\n" + "="*60)
    print("Sample Selection")
    print("="*60)
    print("[*] You need to test at least TWO malware samples")
    print("[*] For safety, we'll ANALYZE (not execute) the code")
    
    selected = []
    
    while len(selected) < 2:
        choice = input(f"\n[?] Select sample number (1-{len(samples)}): ").strip()
        
        if choice.isdigit() and 1 <= int(choice) <= len(samples):
            idx = int(choice) - 1
            if samples[idx] not in selected:
                selected.append(samples[idx])
                analyze_malware_sample(samples[idx])
            else:
                print("[!] Already selected")
        else:
            print("[!] Invalid choice")
    
    # Summary
    print("\n" + "="*60)
    print("Quest Complete!")
    print("="*60)
    print("[âœ“] Cloned malware repository")
    print(f"[âœ“] Analyzed {len(selected)} malware samples:")
    for sample in selected:
        print(f"    - {os.path.basename(sample)}")
    print("\n[*] IMPORTANT: Always use malware samples in isolated environments!")
    print("="*60 + "\n")


if __name__ == "__main__":
    main()
